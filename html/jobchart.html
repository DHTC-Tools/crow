<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">

	<link rel="stylesheet" type="text/css"
		href="//code.jquery.com/ui/1.10.3/themes/redmond/jquery-ui.css">

	<script type="text/javascript" language="javascript"
		src="//code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

	<script type="text/javascript" language="javascript"
		src="//cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>

	<script type="text/javascript" language="javascript"
		src="/assets/js/URI.min.js"></script>

	<script src="//code.highcharts.com/highcharts.js"></script>
	<!-- script src="//code.highcharts.com/modules/exporting.js" -->
</head>
<body>
<style>
#idGraphSpace {
	margin: auto;
}
#flying {
	position: absolute;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
}
#flying img {
	margin: auto;
	display: block;
}
#flying p {
	position: absolute;
	bottom: 0;
	margin-left: 3em;
	margin-right: auto;
	font-size: 50%;
}
</style>

<div id="flying">
	<img src="flying.gif"></img>
	<p>Flying raven by <a href="http://jesseth.deviantart.com/">Jessie Mollodovsky</a></p>
</div>
<div id="idGraphSpace"></div>

<script>
	var uri = URI(window.location.href);
	var query = uri.query(true);

	var params = {
		width: [$(window).width() - 50, parseInt], //800,
		height: [$(window).height() - 50, parseInt], //600,
		hours: [48, parseInt],
		minbin: [10, parseInt],
		pool: ['osg', String],
		groupby: ['ProjectName', String],
		rel: ['default', String],
		start: ['default', String],
		end: ['default', String],
	};

	var groupings = {
		'project': 'ProjectName',
		'user': 'Owner',
	};

	for (var key in params) {
		if (key in query) {
			params[key] = params[key][1](query[key]);
		}
		else {
			params[key] = params[key][0];
		}
	}

	function load() {
		$('#idGraphSpace').css({width: params.width, height: params.height});

		/* Start with one bin per hour */
		bins = params.hours;
		millis = 3600 * 1000;

		/* Bin width is chartwidth/bins.  If this is too small, then make fewer bins */
		while (params.width / bins < params.minbin) {
			bins /= 2;
			millis *= 2;
		}

		var options = {
				chart: {
					renderTo: 'idGraphSpace',
					zoomType: 'xy',
					type: 'column',
					//margin: [ 60, 30, 45, 70 ],
					width: params.width,
					height: params.height
				},
				plotOptions: { column: {
					stacking: 'normal',
					pointPadding: 0.0,
					groupPadding: 0,
					pointInterval: millis,	/* how many millis per data point/bin */
				} },
				title: { text: '' },
				xAxis: { type: 'datetime', tickWidth: 0, gridLineWidth: 1, /* title: { text: 'Date' } */ },
				yAxis: { title: { text: 'Jobs' } },
				legend: { align: 'left', verticalAlign: 'top', y: 10, floating: true, borderWidth: 0 },
				//exporting: {	   buttons: { contextButton: {	text: 'Export' } }, sourceHeight:1050, sourceWidth: 1485	},
				credits: { enabled: false },
				tooltip: { formatter: function() {
					return ('<b>' + this.series.name + '</b><br/>' +
						Highcharts.dateFormat('%a %d %b %Y, %H:%M', this.x) + ' UTC<br/>' +
						'Jobs: ' + this.y)
				} }
		}; 

		// why? $.ajaxSetup({async: false});
		$.ajax({
			type: "POST",
			url: "/service/mongo-crow/starts",
			data: JSON.stringify({
				"project": "all",
				"user": "all",
				"task": "all",
				"hours": params.hours,
				"pool": params.pool,
				"groupby": groupings[params.groupby],
				"bins": bins,
				"width": params.width,
				"rel": params.rel,
				"start": params.start,
				"end": params.end,
			}),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function(data) {
				$('#idGraphSpace').show();
				options.series = data.plot;
				chart = new Highcharts.Chart(options); 
				$('#flying').remove();
			},
			failure: function(errMsg) {
				alert(errMsg);
				$('#idGraphSpace').show();
			}
		});
	}

	$(document).ready(function() {
		$('#idGraphSpace').hide();
		setTimeout(load, 1);
	});
</script>

</body>
</html>
